<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kiosk Y t·∫ø - Ch·ªçn h·ªá c∆° quan</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { background: #f0f9ff; font-family: 'Segoe UI', sans-serif; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
    .option {
      border: 2px solid #e2e8f0; border-radius: 16px; padding: 20px;
      background: #fff; text-align: center; cursor: pointer; transition: .16s;
      user-select: none; height: 120px; display: flex; flex-direction: column; justify-content: center;
    }
    .option:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(13,110,253,.06); }
    .option.selected { border-color: #0d6efd; background: #e7f1ff; box-shadow: 0 12px 28px rgba(13,110,253,.06); }
    .option input { display: none; }
    .emoji { font-size: 28px; line-height: 1; }
    .name { margin-top: 8px; font-weight: 600; font-size: 15px; color: #0b2545; }
    .footer-actions { position: sticky; bottom: 0; background: #f0f9ff; padding-top: 16px; padding-bottom: 8px; }
    .desc { font-size: 12px; color: #6b7280; margin-top: 6px; }
  </style>
</head>

<body class="container py-5">
  <h2 class="text-center mb-4">Ch·ªçn h·ªá c∆° quan c·∫ßn t∆∞ v·∫•n</h2>

  <div class="grid" id="category-grid">
    <!-- s·∫Ω render t·ª± ƒë·ªông -->
  </div>

  <div class="d-flex justify-content-center gap-3 mt-4 footer-actions">
    <a href="index.html" class="btn btn-outline-secondary">Quay l·∫°i</a>
    <button id="continue-btn" class="btn btn-primary">Ti·∫øp t·ª•c</button>
  </div>

  <script>
    const grid = document.getElementById('category-grid');
    const continueBtn = document.getElementById('continue-btn');
    const emojiFallback = 'ü©∫';

    function normalizeText(s) {
      return (s || '')
        .toString()
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[‚Äì‚Äî]/g, '-')
        .replace(/[^a-z0-9\- ]+/g, ' ')
        .trim();
    }
    function tokensOf(s) { return normalizeText(s).split(/\s+/).filter(Boolean); }
    function hasAll(tokens, arr) { return arr.every(k => tokens.includes(k)); }
    function hasAny(tokens, arr) { return arr.some(k => tokens.includes(k)); }

    const rules = [
      { emoji: '‚ö°', any: ['toan','chung','toan-than'] },
      { emoji: 'üå¨Ô∏è', all: ['ho','hap'] },
      { emoji: 'üçΩÔ∏è', all: ['tieu','hoa'] },
      { emoji: 'üß†', all: ['than','kinh'] },
      { emoji: '‚ù§Ô∏è', all: ['tim','mach'] },
      { emoji: 'üß¥', all: ['da','lieu'] },
      { emoji: 'üöª', any: ['nieu','tiet','tiet-nieu','tieu-nieu'] },
      { emoji: 'ü¶¥', any: ['co','xuong','khop','xuong-khop'] },
      { emoji: 'üëÇ', any: ['tai','mui','hong'] },
      { emoji: 'üëÅÔ∏è', any: ['mat','nhan','khoa','nhan-khoa'] },
      { emoji: 'üå∏', all: ['di','ung'] },
      { emoji: 'üå∏', all: ['mien','dich'] },
      { emoji: 'ü§∞', all: ['phu','san'] },
      { emoji: 'üßí', any: ['nhi','em','be','embe'] },
      { emoji: 'ü¶†', any: ['nhiem','khuan'] },
      { emoji: 'ü¶∑', any: ['rang','mieng'] },
      { emoji: '‚ôÇÔ∏è', all: ['sinh','duc','nam'] },
      { emoji: '‚ôÄÔ∏è', all: ['sinh','duc','nu'] },
      { emoji: 'üõå', any: ['tam','than','giac','ngu'] }
    ];

    function chooseEmojiFor(groupName) {
      const tokens = tokensOf(groupName);
      for (const r of rules) {
        if (r.all && hasAll(tokens, r.all)) return r.emoji;
      }
      for (const r of rules) {
        if (r.any && hasAny(tokens, r.any)) return r.emoji;
      }
      return emojiFallback;
    }

    function slugify(s) {
      return normalizeText(s).replace(/\s+/g, '-').replace(/[^a-z0-9\-]/g, '').replace(/\-+/g, '-').replace(/^\-|\-$/g, '');
    }

    function createOptionElement(groupName, slug, emoji) {
      const label = document.createElement('label');
      label.className = 'option';
      label.dataset.value = slug;
      label.tabIndex = 0;
      const input = document.createElement('input');
      input.type = 'radio';
      input.name = 'category';
      input.value = slug;
      const em = document.createElement('div');
      em.className = 'emoji';
      em.textContent = emoji;
      const nm = document.createElement('div');
      nm.className = 'name';
      nm.textContent = groupName;
      label.appendChild(input);
      label.appendChild(em);
      label.appendChild(nm);

      label.addEventListener('keydown', (ev) => {
        if (ev.key === 'Enter' || ev.key === ' ') {
          ev.preventDefault();
          input.checked = true;
          document.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
          label.classList.add('selected');
        }
      });

      label.addEventListener('click', () => {
        input.checked = !input.checked;
        document.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
        label.classList.add('selected');
        input.checked = true;
      });

      return label;
    }

    fetch('/api/groups')
      .then(res => {
        if (!res.ok) throw new Error('Kh√¥ng th·ªÉ l·∫•y /api/groups (status ' + res.status + ')');
        return res.json();
      })
      .then(payload => {
        let raw = [];
        if (Array.isArray(payload)) raw = payload;
        else if (payload && Array.isArray(payload.groups)) raw = payload.groups;
        else if (payload && payload.groups && typeof payload.groups === 'object') raw = payload.groups;
        else throw new Error('D·ªØ li·ªáu /api/groups kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng.');

        const seen = new Map();
        raw.forEach(item => {
          let groupName = '';
          let slug = '';
          if (typeof item === 'string') {
            groupName = item.trim();
          } else if (typeof item === 'object') {
            groupName = (item.group || item['Nh√≥m h·ªá c∆° quan'] || item.name || '').toString().trim();
            slug = item.slug || '';
          }
          if (!groupName) return;
          if (!slug) slug = slugify(groupName);
          if (!seen.has(groupName)) seen.set(groupName, { group: groupName, slug });
        });

        const groups = Array.from(seen.values()).sort((a, b) => a.group.localeCompare(b.group, 'vi'));
        groups.forEach(g => {
          const emoji = chooseEmojiFor(g.group);
          const el = createOptionElement(g.group, g.slug, emoji);
          grid.appendChild(el);
        });
      })
      .catch(err => {
        console.error('L·ªói khi load groups:', err);
        grid.innerHTML = `<p class="text-danger">Kh√¥ng th·ªÉ t·∫£i danh s√°ch nh√≥m: ${err.message}</p>`;
      });

    grid.addEventListener('click', (e) => {
      const label = e.target.closest('.option');
      if (!label) return;
      document.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
      label.classList.add('selected');
      const input = label.querySelector('input[type=radio]');
      if (input) input.checked = true;
    });

    continueBtn.addEventListener('click', () => {
      const selected = document.querySelector('input[name="category"]:checked');
      if (!selected) {
        alert('Vui l√≤ng ch·ªçn m·ªôt h·ªá c∆° quan.');
        return;
      }
      const val = selected.value; // slug
      const name = selected.closest('.option').querySelector('.name')?.textContent || val;
      // L∆∞u t√™n ƒë·ªÉ hi·ªÉn th·ªã, l∆∞u slug ƒë·ªÉ quay l·∫°i subcategory ƒë√∫ng
      localStorage.setItem('selectedCategory', name);
      localStorage.setItem('selectedCategorySlug', val); // <-- th√™m d√≤ng n√†y
      localStorage.removeItem('selectedSymptoms');

      window.location.href = 'subcategory.html?field=' + encodeURIComponent(val);
    });
  </script>
</body>
</html>
